---
aliases: 修改代码的艺术
tags:
  - 读书笔记/修改代码的艺术
date updated: 2024-05-26 12:41
---

## 修改代码的原因

- 添加新特性
- 修正bug
- 改善设计 改变既有软件的结构和组织，以另其更易于维护
- 优化  减少资源使用，内存、时间等

## 修改的风险

- 我们要进行哪些修改
- 我们如何得知已经正确地完成了修改
- 我们如何得知没有破坏任何（既有的）东西

## 修改的方式

### 编辑并祈祷

仔细的计划你所需要进行的改动，并确保自己理解了将要修改的代码，然后再开始改动。结束之后，运行修改后的系统，看看所做的改动是否生效，在然后对系统整体的验证，以确保改动没有破坏什么东西。

### 覆盖并修改

将测试覆盖在我们修改的代码上面，以确保糟糕的改动不会泄露出去并感染到软件的其他部分。这样就可以放心对它进行修改，并快速验出修改是好是坏。==通过测试来检验变化==。

重构修改步骤

1. 确定改动点
2. 找出测试点
3. 解依赖
4. 编写测试
5. 修改、重构

## 单元测试

关心的是一个系统的最为`原子`的行为单元，好的单元测试应具备：

1. 隔离性
2. 运行快
3. 能帮助我们快速定位问题所在

以下不属于单元测试：

1. 跟数据库有交互
2. 进行了网络间通信
3. 调用了文件系统
4. 需要对环境做特定的准备（如编辑配置文件）才能运行的。

## 依赖性

依赖性是软件开发中最为关键的问题之一，在修改代码的过程中很大一部分工作都是围绕着 `解除依赖性以使改动变得更容易` 这个目标来进行的。而编写单元测试，有助于我们解除依赖性

## 修改代码的技术

### 新生方法

当需要往一个系统中添加特性且这个特性完全可以用全新的代码来编写时，建议将这些代码放在一个新的方法中，并在需要用到这个新功能的地方调用这一方法。

实施这个技术的步骤

1. 确定修改点
2. 如果你的修改可以在一个方法中的已出地方以单块连续的语句序列出现，那么在修改点插入一个方法调用，而被调用的就是我们要编写的，用于完成工作的新方法。我们将这一调用先注释掉
3. 确定你需要原方法的那些局部变量，并将它们作为实参传给新方法调用
4. 确定新方法是否需要返回什么值给原方法，如果需要的话就得相应的修改对它的调用，使用一个变量来接受其返回值。
5. 使用测试驱动的开发方式来开发新的方法
6. 使原方法中被注释掉的调用重新生效

优点： 新旧代码被清晰地隔离开，能单独关注所要做的改动，并在新旧代码之间建立清晰地接口，你会看到所有被影响到的变量，更容易确定新的代码在上下文中是否是正确的。

缺点： 原方法测试覆盖范围变化，代码分散

### 外覆方法

当我们想要为原方法添加新行为时，可以创建一个与原方法同名的新方法，并在新方法中调用更名后的原方法。

实施步骤：

1. 确定待修改的方法
2. 如果你的修改可以在一处地方以单块连续的语句序列出现，那么将修改方法重命名，并使用其原先的名字和签名创建一个新方法。
3. 在新方法中调用冲命名后的原方法
4. 为欲添加的新特性编写一个方法，并在第二步创建的新方法中调用这个方法

优点： 新功能独立于既有功能
缺点： 糟糕的命名，新特性无法和旧特性交融在一起，要么在旧特性之前王，要么在之后完成。

### 测试驱动开发

设想有一个方法，能够帮助我们解决问题的某个部分，接下来我们为这个想象中的方法编写一个失败测试用例。此时该方法尚不存在，但既然我们能够为它编写测试，我们就对接下来将要编写的代码要做什么事情有一个确定的认识

实施步骤：

1. 编写一个测试用例
2. 让他通过编译
3. 让测试通过
4. 消除重复
5. 重复上述步骤
